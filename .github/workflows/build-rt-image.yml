name: Build RT Kernel for OrangePi 5 Plus
on:
  push:
    branches: [ '*' ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-rt-kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    env:
      ARMBIAN_DIR: ${{ github.workspace }}/armbian
      BOARD: orangepi5-plus
      BRANCH: current
      RELEASE: bookworm
      KERNEL_BRANCH: linux-6.12.y
      KERNEL_COMMIT: 9becd7c25c61ae7e5b6fbfc3c226b1f23af7638c
      KERNEL_SOURCE: https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
      RT_PATCH_VER: rt12
      KERNEL_VER: 6.12.43

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Build Dependencies (Fix Docker Conflict)
        run: |
          sudo apt update && sudo apt install -y \
            git curl wget unzip build-essential crossbuild-essential-arm64 \
            qemu-user-static rsync libncurses5-dev flex bison libssl-dev \
            bc dwarves python3-distutils xz-utils ca-certificates kmod \
            cpio libelf-dev dpkg-dev
          # 检查Docker状态（GitHub Action默认已安装）
          sudo systemctl start docker
          sudo usermod -aG docker $USER && newgrp docker
          docker --version
          echo "✅ Docker is ready, no need to reinstall"

      - name: Clone Armbian Build Framework
        run: |
          git clone --depth 1 --branch v25.08 https://github.com/armbian/build.git $ARMBIAN_DIR
          cd $ARMBIAN_DIR && git submodule update --init --recursive
          # 禁用缓存检测
          sudo sed -i 's/artifact_is_available_in_remote_cache() {/artifact_is_available_in_remote_cache() { return 1;/g' lib/functions/artifacts/artifacts-obtain.sh
          sudo sed -i 's/artifact_is_available_in_local_cache() {/artifact_is_available_in_local_cache() { return 1;/g' lib/functions/artifacts/artifacts-obtain.sh
          sudo chown -R $USER:$USER $ARMBIAN_DIR

      - name: Prepare RT Patch & Config
        run: |
          # 创建补丁目录
          PATCH_DIR=$ARMBIAN_DIR/userpatches/kernel/rockchip64-${{ env.KERNEL_VER }}
          mkdir -p $PATCH_DIR
          # 写入RT内核配置
          cat > $ARMBIAN_DIR/userpatches/config-custom.conf << EOF
          CONFIG_MODVERSIONS=n
          CONFIG_PREEMPT_RT=y
          CONFIG_PREEMPT=y
          CONFIG_HZ_1000=y
          EOF
          # 解压RT补丁（确保根目录有 patch-6.12.43-rt12.patch.xz）
          PATCH_FILE=patch-${{ env.KERNEL_VER }}-${{ env.RT_PATCH_VER }}.patch.xz
          if [ ! -f $PATCH_FILE ]; then
            echo "ERROR: Patch file $PATCH_FILE not found!" && exit 1
          fi
          xz -d < $PATCH_FILE > $PATCH_DIR/0001-${{ env.RT_PATCH_VER }}.patch
          sudo chown -R $USER:$USER $ARMBIAN_DIR/userpatches

      - name: Configure Armbian Build
        run: |
          cat > $ARMBIAN_DIR/userpatches/config.conf << EOF
          BOARD=${{ env.BOARD }}
          BRANCH=${{ env.BRANCH }}
          RELEASE=${{ env.RELEASE }}
          KERNEL_GIT=${{ env.KERNEL_COMMIT }}
          KERNEL_SOURCE=${{ env.KERNEL_SOURCE }}
          KERNEL_BRANCH=${{ env.KERNEL_BRANCH }}
          KERNEL_CACHE=no
          ARMBIAN_CACHE_MODE=none
          SKIP_REMOTE_CACHE=yes
          SKIP_LOCAL_CACHE=yes
          FORCE_REBUILD=yes
          USE_CCACHE=no
          CONFIG_CUSTOM=$ARMBIAN_DIR/userpatches/config-custom.conf
          NONINTERACTIVE=yes
          VERBOSE=yes
          EOF

      - name: Clone Linux Kernel Source
        run: |
          cd $ARMBIAN_DIR && mkdir -p sources/linux-${{ env.KERNEL_VER }}
          cd sources/linux-${{ env.KERNEL_VER }}
          git init && git remote add origin ${{ env.KERNEL_SOURCE }}
          git config core.sparseCheckout true
          # 只拉取必需目录
          cat > .git/info/sparse-checkout << EOF
          arch/
          block/
          crypto/
          drivers/
          fs/
          include/
          init/
          kernel/
          mm/
          net/
          scripts/
          Makefile
          Kbuild
          Kconfig
          EOF
          git pull --depth=1000 origin ${{ env.KERNEL_BRANCH }}
          # 验证提交
          if git cat-file -e ${{ env.KERNEL_COMMIT }} 2>/dev/null; then
            git checkout ${{ env.KERNEL_COMMIT }}
          else
            echo "ERROR: Commit ${{ env.KERNEL_COMMIT }} not found!" && exit 1
          fi
          sudo chown -R $USER:$USER $ARMBIAN_DIR/sources

      - name: Generate Kernel Config (New CLI)
        run: |
          cd $ARMBIAN_DIR
          ./compile.sh kernel-config \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            KERNEL_GIT=${{ env.KERNEL_COMMIT }} \
            NONINTERACTIVE=yes

      - name: Compile RT Kernel
        run: |
          cd $ARMBIAN_DIR
          ./compile.sh kernel \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            KERNEL_GIT=${{ env.KERNEL_COMMIT }} \
            NONINTERACTIVE=yes

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rt-kernel-${{ env.BOARD }}-${{ env.KERNEL_VER }}
          path: ${{ env.ARMBIAN_DIR }}/output/debs/*.deb
          retention-days: 7