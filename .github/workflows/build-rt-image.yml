name: Native Build RT Kernel (ARM64 Linux) for Orange Pi 5 Plus

on:
  push:
    branches: [ kernel ]
  workflow_dispatch:

concurrency:
  group: arm64-native-rt-kernel
  cancel-in-progress: true

jobs:
  native-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64]
    permissions:
      contents: read
      actions: write
    env:
      # ä½ çš„å®é™…é…ç½®æ–‡ä»¶åç§°ï¼ˆæ ¹ç›®å½•å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
      CUSTOM_CONFIG_FILE: config-6.12.43-current-rockchip64
      # ä½ çš„å®é™… RT è¡¥ä¸åç§°ï¼ˆæ ¹ç›®å½•å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
      RT_PATCH_FILE: patch-6.12.43-rt12.patch.xz
      KERNEL_VERSION: 6.12.43
      KERNEL_LOCALVERSION: -rt12-opi5plus
      ARCH: arm64
      WORK_DIR: ${{ github.workspace }}/work
      KERNEL_SRC: ${{ github.workspace }}/kernel-src
      DEB_OUTPUT: ${{ github.workspace }}/kernel-deb-output

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Local Files
        run: |
          set -e
          # æ ¡éªŒä½ çš„é…ç½®æ–‡ä»¶å’Œ RT è¡¥ä¸æ˜¯å¦å­˜åœ¨ï¼ˆæ ¹ç›®å½•ï¼‰
          if [ ! -f "$CUSTOM_CONFIG_FILE" ]; then
            echo "âŒ æ ¹ç›®å½•æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼š$CUSTOM_CONFIG_FILE"
            ls -la ${{ github.workspace }}
            exit 1
          fi
          if [ ! -f "$RT_PATCH_FILE" ]; then
            echo "âŒ æ ¹ç›®å½•æœªæ‰¾åˆ° RT è¡¥ä¸æ–‡ä»¶ï¼š$RT_PATCH_FILE"
            exit 1
          fi
          # æ ¡éªŒå†…æ ¸3ä¸ªåˆ†å·æ˜¯å¦å­˜åœ¨
          if [ ! -f "${{ github.workspace }}/linux-kernel.tar.gz.part-aa" ] || \
             [ ! -f "${{ github.workspace }}/linux-kernel.tar.gz.part-ab" ] || \
             [ ! -f "${{ github.workspace }}/linux-kernel.tar.gz.part-ac" ]; then
            echo "âŒ æ ¹ç›®å½•ç¼ºå°‘å†…æ ¸åˆ†å·å‹ç¼©åŒ…ï¼ˆaa/ab/acï¼‰"
            exit 1
          fi
          
          CURRENT_ARCH=$(uname -m)
          echo "â„¹ï¸ å½“å‰è¿è¡Œå™¨æ¶æ„ï¼š$CURRENT_ARCHï¼ŒCPU æ ¸å¿ƒæ•°ï¼š$(nproc)"
          if [ "$CURRENT_ARCH" != "aarch64" ]; then
            echo "âš ï¸  å½“å‰ä¸æ˜¯ ARM64 æ¶æ„ï¼Œå¯èƒ½ä¸ºäº¤å‰ç¼–è¯‘ç¯å¢ƒ"
          else
            echo "âœ… ç¡®è®¤æ˜¯ ARM64 æ¶æ„ï¼Œå°†è¿›è¡ŒåŸç”Ÿç¼–è¯‘"
          fi
          echo "âœ… æœ¬åœ°æ–‡ä»¶ï¼ˆé…ç½®+è¡¥ä¸+å†…æ ¸åˆ†å·ï¼‰éªŒè¯é€šè¿‡"

      - name: Install ARM64 Native Build Dependencies
        run: |
          set -e
          sudo apt update -qq
          sudo apt install -y --no-install-recommends --reinstall \
            xz-utils build-essential libncurses5-dev libncursesw5-dev \
            flex bison libssl-dev bc dwarves \
            kmod cpio rsync libelf-dev debhelper fakeroot patch git
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Create Working Directories
        run: |
          set -e
          mkdir -p $WORK_DIR $KERNEL_SRC $DEB_OUTPUT
          echo "âœ… å·¥ä½œç›®å½•åˆ›å»ºå®Œæˆ"

      # ========== æœ€å°ä¿®æ”¹ï¼šä»…æ›¿æ¢è¿™ä¸€æ­¥ï¼ˆåˆå¹¶åˆ†å· + è§£å‹ï¼Œæ— ä¸‹è½½ï¼‰ ==========
      - name: Merge & Extract Kernel Split Compressed Files (No Download)
        run: |
          set -e
          # è¿›å…¥ä»“åº“æ ¹ç›®å½•ï¼Œåˆå¹¶3ä¸ªå†…æ ¸åˆ†å·
          cd ${{ github.workspace }}
          echo "ğŸ“¦ åˆå¹¶å†…æ ¸åˆ†å·ï¼šlinux-kernel.tar.gz.part-aa/ab/ac â†’ linux-kernel.tar.gz"
          cat linux-kernel.tar.gz.part-aa linux-kernel.tar.gz.part-ab linux-kernel.tar.gz.part-ac > linux-kernel.tar.gz
          
          # æ ¡éªŒåˆå¹¶ç»“æœ
          if [ ! -s "linux-kernel.tar.gz" ]; then
            echo "âŒ å†…æ ¸åˆ†å·åˆå¹¶å¤±è´¥"
            exit 1
          fi
          echo "âœ… å†…æ ¸åˆ†å·åˆå¹¶å®Œæˆ"

          # è§£å‹å®Œæ•´å†…æ ¸åŒ…åˆ° KERNEL_SRC
          echo "ğŸ“¦ è§£å‹å†…æ ¸åŒ… â†’ $KERNEL_SRC"
          tar -xf linux-kernel.tar.gz -C $KERNEL_SRC --strip-components=1
          
          # æ ¡éªŒè§£å‹ç»“æœ
          if [ ! -f "$KERNEL_SRC/Makefile" ]; then
            echo "âŒ å†…æ ¸è§£å‹å¤±è´¥"
            ls -la $KERNEL_SRC
            exit 1
          fi
          echo "âœ… å†…æ ¸æºç è§£å‹å®Œæˆ"

          # åŸæœ‰ Git åˆå§‹åŒ–é€»è¾‘ï¼ˆä¿ç•™ï¼Œä¸ä¿®æ”¹ï¼‰
          cd $KERNEL_SRC
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Fake commit for deb-pkg (skip git check)"
          echo "âœ… Git ä»“åº“åˆå§‹åŒ–å®Œæˆ"

          echo "âœ… å†…æ ¸åˆ†å·åˆå¹¶ + è§£å‹ + Git åˆå§‹åŒ–å…¨éƒ¨å®Œæˆ"
      # ========== ä»¥ä¸Šä¸ºä¿®æ”¹éƒ¨åˆ†ï¼Œä»¥ä¸‹æ‰€æœ‰æ­¥éª¤å®Œå…¨ä¸å˜ ==========

      - name: Apply RT Patch & Load Custom Config (Single Thread)
        run: |
          set -e
          cd $KERNEL_SRC
          cp ${{ github.workspace }}/$CUSTOM_CONFIG_FILE ./.config
          echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰é…ç½®ï¼š$CUSTOM_CONFIG_FILE"

          # åŸæœ‰æ‰“è¡¥ä¸é€»è¾‘ï¼ˆç›´æ¥è¯»å–æ ¹ç›®å½•è¡¥ä¸ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
          xz -d -c ${{ github.workspace }}/$RT_PATCH_FILE | patch -p1 --verbose
          if [ $? -eq 0 ] || [ $? -eq 1 ]; then
            echo "âœ… RT è¡¥ä¸åº”ç”¨æˆåŠŸï¼ˆè¿”å›ç ï¼š$?ï¼‰"
          else
            echo "âŒ RT è¡¥ä¸åº”ç”¨å¤±è´¥ï¼ˆè¿”å›ç ï¼š$?ï¼‰"
            exit 1
          fi

          # åŸæœ‰å†…æ ¸é…ç½®é€»è¾‘ï¼ˆä¸ä¿®æ”¹ï¼‰
          echo "CONFIG_LOCALVERSION=\"$KERNEL_LOCALVERSION\"" >> .config
          sed -i 's/^# CONFIG_PREEMPT_RT is not set/CONFIG_PREEMPT_RT=y/' .config
          sed -i 's/^CONFIG_PREEMPT=.*/CONFIG_PREEMPT=y/' .config
          sed -i 's/^CONFIG_HZ=.*/CONFIG_HZ=1000/' .config
          sed -i 's/^CONFIG_MODVERSIONS=.*/CONFIG_MODVERSIONS=n/' .config
          sed -i 's/^CONFIG_BUILD_DOCS=.*/CONFIG_BUILD_DOCS=n/' .config
          sed -i 's/^# CONFIG_KERNEL_GIT_INFO is not set/CONFIG_KERNEL_GIT_INFO=n/' .config

          make ARCH=$ARCH olddefconfig
          echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"

      - name: Native Compile RT Kernel (Multi-Thread)
        run: |
          set -e
          cd $KERNEL_SRC
          make ARCH=$ARCH -j$(nproc) Image modules dtbs
          echo "âœ… å†…æ ¸å¤šçº¿ç¨‹ç¼–è¯‘å®Œæˆï¼ˆä½¿ç”¨ $(nproc) æ ¸å¿ƒï¼‰"

      - name: Build ARM64 Deb Package (Native Multi-Thread)
        run: |
          set -e
          cd $KERNEL_SRC
          make ARCH=$ARCH -j$(nproc) \
            LOCALVERSION=$KERNEL_LOCALVERSION \
            KDEB_PKGVERSION=$KERNEL_VERSION$KERNEL_LOCALVERSION \
            KDEB_DEBARCH=arm64 \
            KBUILD_BUILD_VERSION=1 \
            deb-pkg
          cp $WORK_DIR/*.deb $DEB_OUTPUT/
          echo "âœ… deb åŒ…ç”Ÿæˆå®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la $DEB_OUTPUT/

      - name: Package Standalone Modules & Image (Single Thread)
        run: |
          set -e
          cd $KERNEL_SRC
          MODULES_DIR=$DEB_OUTPUT/kernel-modules-$KERNEL_VERSION$KERNEL_LOCALVERSION
          mkdir -p $MODULES_DIR/lib/modules
          make ARCH=$ARCH INSTALL_MOD_PATH=$MODULES_DIR modules_install
          tar -zcf $MODULES_DIR.tar.gz -C $DEB_OUTPUT $(basename $MODULES_DIR)
          rm -rf $MODULES_DIR

          IMG_DTB_DIR=$DEB_OUTPUT/kernel-img-dtb-$KERNEL_VERSION$KERNEL_LOCALVERSION
          mkdir -p $IMG_DTB_DIR/boot
          cp arch/arm64/boot/Image $IMG_DTB_DIR/boot/
          DTB_FILE=rk3588-orangepi-5-plus.dtb
          if [ -f "arch/arm64/boot/dts/rockchip/$DTB_FILE" ]; then
            cp "arch/arm64/boot/dts/rockchip/$DTB_FILE" $IMG_DTB_DIR/boot/
            echo "âœ… è®¾å¤‡æ ‘ $DTB_FILE å¤åˆ¶å®Œæˆ"
          fi
          tar -zcf $IMG_DTB_DIR.tar.gz -C $DEB_OUTPUT $(basename $IMG_DTB_DIR)
          rm -rf $IMG_DTB_DIR

          echo "âœ… ç‹¬ç«‹æ¨¡å—å’Œé•œåƒåŒ…ç”Ÿæˆå®Œæˆ"

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RT-Kernel-OrangePi5Plus-ARM64-Native-$KERNEL_VERSION$KERNEL_LOCALVERSION
          path: |
            ${{ env.DEB_OUTPUT }}/*.deb
            ${{ env.DEB_OUTPUT }}/*.tar.gz
          retention-days: 90