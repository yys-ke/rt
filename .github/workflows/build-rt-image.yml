name: Build RT kernel deb (any branch)

on: push        # 任何分支都触发

jobs:
  kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git curl wget unzip build-essential debhelper \
            crossbuild-essential-arm64 qemu-user-static ccache rsync \
            libncurses5-dev flex bison libssl-dev bc dwarves python3-distutils xz-utils ca-certificates

      - name: 拉取 Armbian 源码
        run: git clone --depth 1 --branch v25.08 https://github.com/armbian/build.git armbian

      - name: 恢复 ccache
        uses: actions/cache@v4
        with:
          path: ccache
          key: kernel-ccache-${{ runner.os }}-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            kernel-ccache-${{ runner.os }}-${{ github.ref }}-
            kernel-ccache-${{ runner.os }}-

      - name: 放入用户补丁
        run: |
          mkdir -p armbian/userpatches
          # 1. 跳过 trixie 缺失包
          cp lib.config armbian/userpatches/lib.config
          # 2. 关闭 MODVERSIONS（改名避开保留字）
          echo 'CONFIG_MODVERSIONS=n' > armbian/userpatches/config-rt.conf

      - name: 打入 RT 补丁
        run: |
          mkdir -p armbian/userpatches/kernel/rockchip-rk3588-6.12
          xz -d < patch-6.12.43-rt12.patch.xz > armbian/userpatches/kernel/rockchip-rk3588-6.12/rt12.patch

      - name: 编译内核（新 CLI）
        run: |
          cd armbian
          ./compile.sh kernel \
            BOARD=orangepi5-plus \
            BRANCH=current \
            RELEASE=bookworm \
            KERNEL_CONFIGURE=prebuilt \
            USERPATCHES_ID=rt \
            USE_CCACHE=yes \
            CCACHE_DIR=$GITHUB_WORKSPACE/ccache

      - name: 上传内核 deb 包
        uses: actions/upload-artifact@v4
        with:
          name: kernel-rt-debs-${{ github.ref_name }}-${{ github.run_number }}
          path: armbian/output/debs/*.deb
          retention-days: 90

      - name: 上传日志（失败时）
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-logs-${{ github.ref_name }}-${{ github.run_number }}
          path: armbian/output/logs/
          retention-days: 7