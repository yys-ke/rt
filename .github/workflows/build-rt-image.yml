name: Build full offline bundle – OPi3B 6.1.115 + RT43

# 任意分支 push 即触发
on:
  workflow_dispatch:
  push:
    branches:
      - '**'

env:
  ARMBIAN_VER: v26.2.0-trunk.114     # 真实存在 tag
  BOARD:       orangepi3b
  BRANCH:      vendor                # 与官方镜像同分支
  RELEASE:     trixie                # 与官方镜像同发行版
  KERNEL_TAG:  v6.1.115
  PATCH_FILE:  patch-6.1.112-rt43.patch.xz

jobs:
  offline:
    runs-on: ubuntu-latest
    steps:
      # ---------- 1. 清理磁盘 ----------
      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      # ---------- 2. 检出 Armbian 构建框架 ----------
      - name: Checkout Armbian
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref:        ${{ env.ARMBIAN_VER }}
          path:       build

      # ---------- 3. 检出补丁仓库 ----------
      - name: Checkout patches repo
        uses: actions/checkout@v4
        with:
          path: patches

      # ---------- 4. 放置 RT 补丁 ----------
      - name: Install RT patch
        run: |
          mkdir -p build/userpatches
          xzcat patches/${{ env.PATCH_FILE }} \
               > build/userpatches/kernel-rt.patch
          cat <<EOF > build/userpatches/lib.config
          LINUXFAMILY=rockchip64
          KERNELBRANCH='branch:linux-6.1.y'
          KERNELTAG='${{ env.KERNEL_TAG }}'
          KERNEL_PATCHES='userpatches/kernel-rt.patch'
          EOF

      # ---------- 5. 安装依赖（含 qemu-user-static） ----------
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu \
            libncurses-dev libssl-dev bc bison flex dwarves zstd \
            qemu-user-static

      # ---------- 6. 下载完整源码（非交互） ----------
      - name: Download sources
        working-directory: build
        run: |
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            BUILD_ONLY=kernel \
            DOWNLOAD_ONLY=yes \
            KERNEL_CONFIGURE=no \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=yes

      # ---------- 7. 打包完整离线包 ----------
      - name: Create full offline bundle
        run: |
          tar -C .. -cf - \
             build  cache  output \
            | zstd -19 > full-offline-opi3b-6.1.115-rt43.tar.zst
          ls -lh full-offline-opi3b-6.1.115-rt43.tar.zst

      # ---------- 8. 上传 ----------
      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: full-offline-opi3b-6.1.115-rt43
          path: full-offline-opi3b-6.1.115-rt43.tar.zst
          retention-days: 7