name: Build RT Kernel (OrangePi 5 Plus)
on:
  push:
    branches: ['*']
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  build-rt-kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: read
    env:
      ARMBIAN_DIR: ${{ github.workspace }}/armbian
      BOARD: orangepi5-plus
      BRANCH: current
      RELEASE: bookworm
      KERNEL_BRANCH: linux-6.12.y
      KERNEL_COMMIT: 9becd7c25c61ae7e5b6fbfc3c226b1f23af7638c
      KERNEL_SNAPSHOT_URL: "https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-${{ env.KERNEL_COMMIT }}.tar.gz"
      USERPATCHES_ID: rt
      RT_PATCH_VERSION: rt12
      KERNEL_VERSION: 6.12.43
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Init Env
        run: |
          sudo apt update -qq
          sudo apt remove -y containerd.io docker-ce docker-ce-cli || true
          sudo apt autoremove -y -qq
          sudo apt install -y git curl wget build-essential crossbuild-essential-arm64 qemu-user-static rsync libncurses5-dev flex bison libssl-dev bc dwarves python3-distutils xz-utils kmod cpio libelf-dev
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com | sudo sh
            sudo systemctl start docker
          fi
          sudo usermod -aG docker $USER
          newgrp docker
      - name: Pull Armbian
        run: |
          git clone --depth 1 --branch v25.08 https://github.com/armbian/build.git ${{ env.ARMBIAN_DIR }}
          cd ${{ env.ARMBIAN_DIR }}
          git submodule update --init --recursive
          sudo sed -i 's/artifact_is_available_in_remote_cache() {/artifact_is_available_in_remote_cache() { return 1;/g' ${{ env.ARMBIAN_DIR }}/lib/functions/artifacts/artifacts-obtain.sh
          sudo sed -i 's/artifact_is_available_in_local_cache() {/artifact_is_available_in_local_cache() { return 1;/g' ${{ env.ARMBIAN_DIR }}/lib/functions/artifacts/artifacts-obtain.sh
      - name: Prepare Patches
        run: |
          PATCH_DIR=${{ env.ARMBIAN_DIR }}/userpatches/kernel/rockchip64-${{ env.KERNEL_VERSION }}
          mkdir -p $PATCH_DIR
          echo 'CONFIG_MODVERSIONS=n' > ${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf
          echo 'CONFIG_PREEMPT_RT=y' >> ${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf
          echo 'CONFIG_PREEMPT=y' >> ${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf
          echo 'CONFIG_HZ_1000=y' >> ${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf
          PATCH_FILE="patch-${{ env.KERNEL_VERSION }}-${{ env.RT_PATCH_VERSION }}.patch.xz"
          if [ ! -f $PATCH_FILE ]; then exit 1; fi
          xz -d < $PATCH_FILE > $PATCH_DIR/0001-${{ env.RT_PATCH_VERSION }}.patch
      - name: Clean Caches
        run: |
          rm -rf ${{ env.ARMBIAN_DIR }}/cache/* ${{ env.ARMBIAN_DIR }}/output/* ${{ env.ARMBIAN_DIR }}/sources/* ${{ env.ARMBIAN_DIR }}/tmp/*
          sudo rm -rf /armbian/*
          docker system prune -af
      - name: Write Config
        run: |
          cat > ${{ env.ARMBIAN_DIR }}/userpatches/config.conf << EOF
          BOARD="${{ env.BOARD }}"
          BRANCH="${{ env.BRANCH }}"
          RELEASE="${{ env.RELEASE }}"
          KERNEL_GIT="${{ env.KERNEL_COMMIT }}"
          KERNEL_SOURCE="${{ env.KERNEL_SNAPSHOT_URL }}"
          KERNEL_BRANCH="${{ env.KERNEL_BRANCH }}"
          KERNEL_CACHE="no"
          USERPATCHES_ID="${{ env.USERPATCHES_ID }}"
          ARMBIAN_CACHE_MODE="none"
          SKIP_REMOTE_CACHE="yes"
          SKIP_LOCAL_CACHE="yes"
          FORCE_REBUILD="yes"
          USE_CCACHE="no"
          CONFIG_CUSTOM="${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf"
          CUSTOM_HASH="rt-kernel-$(date +%s)"
          NONINTERACTIVE="yes"
          VERBOSE="yes"
          KERNEL_GIT_REPO_LOCAL="yes"
          EOF
      - name: Download Kernel
        run: |
          wget -q -O ${{ github.workspace }}/linux-kernel.tar.gz ${{ env.KERNEL_SNAPSHOT_URL }}
          mkdir -p ${{ env.ARMBIAN_DIR }}/sources/linux-${{ env.KERNEL_VERSION }}
          tar -zxf ${{ github.workspace }}/linux-kernel.tar.gz -C ${{ env.ARMBIAN_DIR }}/sources/linux-${{ env.KERNEL_VERSION }} --strip-components=1
          if [ ! -f ${{ env.ARMBIAN_DIR }}/sources/linux-${{ env.KERNEL_VERSION }}/Makefile ]; then exit 1; fi
      - name: Gen Kernel Config
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          ./compile.sh kernel-config "BOARD=${{ env.BOARD }}" "BRANCH=${{ env.BRANCH }}" "RELEASE=${{ env.RELEASE }}" "KERNEL_GIT=${{ env.KERNEL_COMMIT }}" "CONFIG_CUSTOM=${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf" "NONINTERACTIVE=yes" "VERBOSE=yes"
      - name: Compile Kernel
        run: |
          cd ${{ env.ARMBIAN_DIR }}
          ./compile.sh kernel "BOARD=${{ env.BOARD }}" "BRANCH=${{ env.BRANCH }}" "RELEASE=${{ env.RELEASE }}" "KERNEL_GIT=${{ env.KERNEL_COMMIT }}" "KERNEL_SOURCE=${{ env.KERNEL_SNAPSHOT_URL }}" "KERNEL_BRANCH=${{ env.KERNEL_BRANCH }}" "KERNEL_CACHE=no" "USERPATCHES_ID=${{ env.USERPATCHES_ID }}" "ARMBIAN_CACHE_MODE=none" "SKIP_REMOTE_CACHE=yes" "SKIP_LOCAL_CACHE=yes" "FORCE_REBUILD=yes" "USE_CCACHE=no" "CONFIG_CUSTOM=${{ env.ARMBIAN_DIR }}/userpatches/config-custom.conf" "CUSTOM_HASH=rt-kernel-$(date +%s)" "NONINTERACTIVE=yes" "VERBOSE=yes" "MAKE_JOBS=1" "SET_OWNER_TO_UID=$(id -u)"
      - name: Verify Artifacts
        run: |
          DEB_FILES=${{ env.ARMBIAN_DIR }}/output/debs/*.deb
          if [ -z "$(ls $DEB_FILES 2>/dev/null)" ]; then exit 1; fi
          if ! dpkg -I $DEB_FILES | grep -qi "rt"; then exit 1; fi
      - name: Upload Deb
        uses: actions/upload-artifact@v4
        with:
          name: rt-kernel-${{ env.BOARD }}-${{ env.KERNEL_VERSION }}
          path: ${{ env.ARMBIAN_DIR }}/output/debs/*.deb
      - name: Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ env.ARMBIAN_DIR }}/output/logs/*