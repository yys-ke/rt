name: Cross Compile RT Kernel (Deb + Modules) for Orange Pi 5 Plus

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: cross-compile-rt-kernel
  cancel-in-progress: true

jobs:
  cross-compile:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write
    env:
      # 你的文件配置
      CUSTOM_CONFIG_FILE: config-6.12.43-current-rockchip64
      RT_PATCH_FILE: patch-6.12.43-rt12.patch.xz
      KERNEL_SRC_URL: https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9becd7c25c61ae7e5b6fbfc3c226b1f23af7638c.tar.gz
      KERNEL_VERSION: 6.12.43
      KERNEL_LOCALVERSION: -rt12-opi5plus
      # 交叉编译核心参数
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
      # 工作目录
      WORK_DIR: ${{ github.workspace }}/work
      KERNEL_SRC: ${{ github.workspace }}/kernel-src
      DEB_OUTPUT: ${{ github.workspace }}/kernel-deb-output

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Local Files
        run: |
          set -e
          if [ ! -f "$CUSTOM_CONFIG_FILE" ]; then
            echo "❌ 未找到自定义配置文件：$CUSTOM_CONFIG_FILE"
            ls -la ${{ github.workspace }}
            exit 1
          fi
          if [ ! -f "$RT_PATCH_FILE" ]; then
            echo "❌ 未找到 RT 补丁文件：$RT_PATCH_FILE"
            exit 1
          fi
          echo "✅ 本地文件验证通过"

      - name: Install ONLY x86_64 Cross-Compile Dependencies
        run: |
          set -e
          sudo apt update -qq
          # 只安装 x86_64 平台的交叉编译工具，无任何 arm64 包
          sudo apt install -y --no-install-recommends \
            xz-utils build-essential libncurses5-dev libncursesw5-dev \
            flex bison libssl-dev bc dwarves \
            crossbuild-essential-arm64 gcc-aarch64-linux-gnu \
            kmod cpio rsync libelf-dev debhelper fakeroot binutils-aarch64-linux-gnu
          # 验证交叉编译器
          if ! $CROSS_COMPILE gcc --version; then
            echo "❌ 交叉编译器 aarch64-linux-gnu-gcc 未安装成功"
            exit 1
          fi
          echo "✅ x86_64 交叉编译环境安装完成"

      - name: Create Working Directories
        run: |
          set -e
          mkdir -p $WORK_DIR $KERNEL_SRC $DEB_OUTPUT
          echo "✅ 工作目录创建完成"

      - name: Download & Extract Kernel Source
        run: |
          set -e
          cd $WORK_DIR
          wget -q $KERNEL_SRC_URL -O kernel-src.tar.gz
          tar -xf kernel-src.tar.gz -C $KERNEL_SRC --strip-components=1
          if [ ! -f "$KERNEL_SRC/Makefile" ]; then
            echo "❌ 内核源码解压失败"
            exit 1
          fi
          echo "✅ 内核源码下载解压完成"

      - name: Apply RT Patch & Load Custom Config
        run: |
          set -e
          cd $KERNEL_SRC
          # 复制你的自定义配置
          cp ${{ github.workspace }}/$CUSTOM_CONFIG_FILE ./.config
          echo "✅ 已加载自定义配置：$CUSTOM_CONFIG_FILE"

          # 单线程打 RT 补丁，避免多线程冲突
          xz -d -c ${{ github.workspace }}/$RT_PATCH_FILE | patch -p1 -j1
          if [ $? -eq 0 ]; then
            echo "✅ RT 补丁应用成功"
          else
            echo "⚠️ RT 补丁应用有警告（偏移不匹配），继续执行"
          fi

          # 强制开启 RT 配置 + 版本后缀
          echo "CONFIG_LOCALVERSION=\"$KERNEL_LOCALVERSION\"" >> .config
          sed -i 's/^# CONFIG_PREEMPT_RT is not set/CONFIG_PREEMPT_RT=y/' .config
          sed -i 's/^CONFIG_PREEMPT=.*/CONFIG_PREEMPT=y/' .config
          sed -i 's/^CONFIG_HZ=.*/CONFIG_HZ=1000/' .config
          sed -i 's/^CONFIG_MODVERSIONS=.*/CONFIG_MODVERSIONS=n/' .config
          # 禁用文档编译，加速构建
          sed -i 's/^CONFIG_BUILD_DOCS=.*/CONFIG_BUILD_DOCS=n/' .config

          # 单线程补全配置（交叉编译必须确保配置正确）
          make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j1 olddefconfig
          echo "✅ 内核配置完成，版本后缀：$KERNEL_LOCALVERSION"

      - name: Cross Compile RT Kernel (Image + Modules + DTBs)
        run: |
          set -e
          cd $KERNEL_SRC
          # 交叉编译内核镜像、模块、设备树（2线程平衡速度和稳定性）
          make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j2 Image modules dtbs
          echo "✅ arm64 RT 内核交叉编译完成"

      - name: Build arm64 Deb Package (Cross-Compile Mode)
        run: |
          set -e
          cd $KERNEL_SRC
          # 关键：指定 deb 包架构为 arm64，无需主机安装 arm64 库
          make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j2 \
            LOCALVERSION=$KERNEL_LOCALVERSION \
            KDEB_PKGVERSION=$KERNEL_VERSION$KERNEL_LOCALVERSION \
            KDEB_DEBARCH=arm64 \
            deb-pkg
          # 复制生成的 deb 包到输出目录
          cp $WORK_DIR/*.deb $DEB_OUTPUT/
          echo "✅ arm64 RT 内核 deb 包生成完成，文件列表："
          ls -la $DEB_OUTPUT/

      - name: Package Standalone Kernel Modules (arm64)
        run: |
          set -e
          cd $KERNEL_SRC
          MODULES_DIR=$DEB_OUTPUT/kernel-modules-$KERNEL_VERSION$KERNEL_LOCALVERSION
          mkdir -p $MODULES_DIR/lib/modules
          # 安装模块到 arm64 架构的目录结构
          make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE \
            INSTALL_MOD_PATH=$MODULES_DIR modules_install
          # 压缩模块包
          tar -zcf $MODULES_DIR.tar.gz -C $DEB_OUTPUT $(basename $MODULES_DIR)
          rm -rf $MODULES_DIR
          echo "✅ arm64 独立内核模块包生成完成"

      - name: Package Kernel Image & DTBs (arm64)
        run: |
          set -e
          IMG_DTB_DIR=$DEB_OUTPUT/kernel-img-dtb-$KERNEL_VERSION$KERNEL_LOCALVERSION
          mkdir -p $IMG_DTB_DIR/boot
          # 复制 arm64 内核镜像
          cp $KERNEL_SRC/arch/arm64/boot/Image $IMG_DTB_DIR/boot/
          # 复制香橙派5 Plus 设备树
          DTB_FILE=rk3588-orangepi-5-plus.dtb
          if [ -f "$KERNEL_SRC/arch/arm64/boot/dts/rockchip/$DTB_FILE" ]; then
            cp $KERNEL_SRC/arch/arm64/boot/dts/rockchip/$DTB_FILE $IMG_DTB_DIR/boot/
            echo "✅ 设备树文件 $DTB_FILE 复制完成"
          else
            echo "⚠️ 未找到设备树文件 $DTB_FILE，跳过"
          fi
          # 压缩镜像+设备树包
          tar -zcf $IMG_DTB_DIR.tar.gz -C $DEB_OUTPUT $(basename $IMG_DTB_DIR)
          rm -rf $IMG_DTB_DIR
          echo "✅ arm64 内核镜像+设备树包生成完成"

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RT-Kernel-OrangePi5Plus-arm64-$KERNEL_VERSION$KERNEL_LOCALVERSION
          path: |
            ${{ env.DEB_OUTPUT }}/*.deb
            ${{ env.DEB_OUTPUT }}/*.tar.gz
          retention-days: 90