name: Build offline – OPi3B vendor（本地 config）

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

env:
  ARMBIAN_VER: v26.2.0-trunk.114
  BOARD:       orangepi3b
  BRANCH:      vendor                     # 用 vendor 分支
  RELEASE:     trixie
  # KERNEL_TAG  去掉，用 vendor 最新
  PATCH_FILE:  patch-6.1.112-rt43.patch.xz
  CONFIG_FILE: config-6.1.115-vendor-rk35xx  # 本地 config 文件名

jobs:
  offline:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      - name: Checkout Armbian
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref:        ${{ env.ARMBIAN_VER }}
          path:       build

      - name: Checkout patches repo
        uses: actions/checkout@v4
        with:
          path: patches

      # 放置 RT 补丁 + 本地 vendor config（带存在校验）
      - name: Install RT patch & vendor config
        run: |
          mkdir -p build/userpatches/kernel
          xzcat patches/${{ env.PATCH_FILE }} > build/userpatches/kernel-rt.patch
          # 显式检查文件是否存在
          ls -la "$GITHUB_WORKSPACE"
          file "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}"
          # 复制本地 config
          cp "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" \
             build/userpatches/kernel/linux-rockchip64-vendor.config
          cat <<EOF > build/userpatches/lib.config
          LINUXFAMILY=rockchip64
          # 用 vendor 最新 tag，不指定 KERNELTAG
          KERNEL_PATCHES='userpatches/kernel-rt.patch'
          KERNEL_CONFIG_NAME=linux-rockchip64-vendor   # 告诉 Armbian 用这份 config
          # 强制 cache/output 写到宿主机同级目录，方便打包
          ARMBIAN_CACHE_DIR="$GITHUB_WORKSPACE/cache"
          ARMBIAN_OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          EOF

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu \
            libncurses-dev libssl-dev bc bison flex dwarves zstd \
            qemu-user-static

      - name: Download sources
        working-directory: build
        run: |
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            BUILD_ONLY=kernel \
            DOWNLOAD_ONLY=yes \
            KERNEL_CONFIGURE=no \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=yes

      - name: Pack offline bundle
        if: always()
        run: |
          tar --exclude='cache/aptcache/*/lock' \
              --exclude='cache/aptcache/*/partial' \
              -C "$GITHUB_WORKSPACE" \
              -cf - build cache output \
            | zstd -19 > full-offline-opi3b-vendor-local.tar.zst
          ls -lh full-offline-opi3b-vendor-local.tar.zst

      - name: Upload bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-offline-opi3b-vendor-local
          path: full-offline-opi3b-vendor-local.tar.zst
          retention-days: 7