name: Build stable RT kernel deb (OrangePi 5 Plus)

# 触发条件：任何分支推送代码时触发
on: 
  push:
    branches: [ '*' ]  # 所有分支都触发
  # 可选：添加手动触发（方便调试）
  workflow_dispatch:

jobs:
  build-rt-kernel:
    runs-on: ubuntu-22.04
    # 设置必要权限
    permissions:
      contents: read
      actions: read
    # 定义全局环境变量，统一路径
    env:
      CCACHE_DIR: ${{ github.workspace }}/ccache
      ARMBIAN_DIR: ${{ github.workspace }}/armbian
      BOARD: orangepi5-plus
      BRANCH: current
      RELEASE: bookworm
      KERNEL_COMMIT: 9becd7c25c61ae7e5b6fbfc3c226b1f23af7638c
      USERPATCHES_ID: rt

    steps:
      ###########################################################################
      # 步骤1：拉取代码（包含你的补丁文件、配置文件）
      ###########################################################################
      - name: Checkout local repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 仅拉取最新代码，加速

      ###########################################################################
      # 步骤2：系统环境准备 & 依赖安装（修复Docker冲突）
      ###########################################################################
      - name: Prepare system environment
        run: |
          echo "===== 更新系统包列表 ====="
          sudo apt-get update -qq
          
          echo "===== 清理冲突的Docker包 ====="
          sudo apt-get remove -y --purge containerd.io docker-ce docker-ce-cli || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          
          echo "===== 安装核心编译依赖 ====="
          sudo apt-get install -y --no-install-recommends \
            git curl wget unzip build-essential debhelper \
            crossbuild-essential-arm64 qemu-user-static ccache rsync \
            libncurses5-dev flex bison libssl-dev bc dwarves python3-distutils \
            xz-utils ca-certificates kmod cpio libelf-dev

          echo "===== 安装兼容版Docker（适配Armbian编译） ====="
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh --mirror Aliyun
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          echo "===== 验证关键工具 ====="
          docker --version
          ccache --version
          gcc --version
          
          echo "===== 配置Docker权限 ====="
          sudo usermod -aG docker $USER
          newgrp docker

      ###########################################################################
      # 步骤3：拉取Armbian编译框架源码
      ###########################################################################
      - name: Pull Armbian build framework
        run: |
          echo "===== 克隆Armbian v25.08版本 ====="
          git clone --depth 1 --branch v25.08 https://github.com/armbian/build.git $ARMBIAN_DIR
          
          echo "===== 更新Armbian子模块 ====="
          cd $ARMBIAN_DIR
          git submodule update --init --recursive

      ###########################################################################
      # 步骤4：CCache缓存恢复（加速编译）
      ###########################################################################
      - name: Restore CCACHE cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: kernel-ccache-${{ runner.os }}-${{ env.BOARD }}-${{ github.sha }}
          restore-keys: |
            kernel-ccache-${{ runner.os }}-${{ env.BOARD }}-
            kernel-ccache-${{ runner.os }}-

      ###########################################################################
      # 步骤5：准备用户自定义配置 & 补丁
      ###########################################################################
      - name: Prepare user patches and configs
        run: |
          echo "===== 创建用户补丁目录 ====="
          mkdir -p $ARMBIAN_DIR/userpatches
          mkdir -p $ARMBIAN_DIR/userpatches/kernel/rockchip-rk3588-6.12
          
          echo "===== 复制自定义配置文件 ====="
          # 1. 跳过trixie缺失包配置
          if [ -f lib.config ]; then
            cp lib.config $ARMBIAN_DIR/userpatches/lib.config
          else
            echo "警告：lib.config文件不存在，跳过复制"
          fi
          
          # 2. 关闭MODVERSIONS（RT补丁必需）
          echo 'CONFIG_MODVERSIONS=n' > $ARMBIAN_DIR/userpatches/config-rt.conf
          
          echo "===== 解压RT补丁 ====="
          # 检查补丁文件是否存在
          if [ ! -f patch-6.12.43-rt12.patch.xz ]; then
            echo "错误：RT补丁文件 patch-6.12.43-rt12.patch.xz 不存在！"
            exit 1
          fi
          # 解压补丁到指定目录
          xz -d < patch-6.12.43-rt12.patch.xz > $ARMBIAN_DIR/userpatches/kernel/rockchip-rk3588-6.12/rt12.patch
          
          echo "===== 验证补丁文件 ====="
          if [ ! -f $ARMBIAN_DIR/userpatches/kernel/rockchip-rk3588-6.12/rt12.patch ]; then
            echo "错误：RT补丁解压失败！"
            exit 1
          fi
          
          echo "===== 设置目录权限 ====="
          chmod -R 755 $ARMBIAN_DIR/userpatches

      ###########################################################################
      # 步骤6：清理旧产物（避免缓存干扰）
      ###########################################################################
      - name: Clean old artifacts
        run: |
          echo "===== 清理旧的编译产物 ====="
          rm -rf $ARMBIAN_DIR/output/{debs,packages-hashed}/* || true
          rm -rf $ARMBIAN_DIR/tmp/* || true

      ###########################################################################
      # 步骤7：编译RT内核（强制重新编译，禁用缓存）
      ###########################################################################
      - name: Compile RT kernel (force rebuild)
        run: |
          echo "===== 进入Armbian编译目录 ====="
          cd $ARMBIAN_DIR
          
          echo "===== 开始编译RT内核 ====="
          ./compile.sh kernel \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            KERNEL_GIT=${{ env.KERNEL_COMMIT }} \
            KERNEL_CONFIGURE=no \
            USERPATCHES_ID=${{ env.USERPATCHES_ID }} \
            ARMBIAN_CACHE_MODE=none \
            USE_CCACHE=yes \
            CCACHE_DIR=${{ env.CCACHE_DIR }} \
            # 核心：禁用所有缓存，强制重新编译
            SKIP_REMOTE_CACHE=yes \
            SKIP_LOCAL_CACHE=yes \
            FORCE_REBUILD=yes \
            # CI环境适配
            SKIP_LOG_ARCHIVE=yes \
            NONINTERACTIVE=yes \
            SET_OWNER_TO_UID=$(id -u) \
            # 调试用：显示详细日志
            VERBOSE=yes

      ###########################################################################
      # 步骤8：验证编译产物
      ###########################################################################
      - name: Verify compiled artifacts
        run: |
          echo "===== 检查deb包是否生成 ====="
          DEB_FILES=$ARMBIAN_DIR/output/debs/*.deb
          if [ -z "$(ls $DEB_FILES 2>/dev/null)" ]; then
            echo "错误：未生成内核deb包！"
            echo "===== 打印编译日志 ====="
            cat $ARMBIAN_DIR/output/logs/*.log || true
            exit 1
          fi
          
          echo "===== 列出生成的deb包 ====="
          ls -lh $ARMBIAN_DIR/output/debs/

      ###########################################################################
      # 步骤9：上传内核deb包（产物）
      ###########################################################################
      - name: Upload RT kernel deb packages
        uses: actions/upload-artifact@v4
        with:
          name: rt-kernel-debs-${{ env.BOARD }}-${{ env.RELEASE }}-${{ github.ref_name }}-${{ github.run_number }}
          path: ${{ env.ARMBIAN_DIR }}/output/debs/*.deb
          retention-days: 90  # 产物保留90天

      ###########################################################################
      # 步骤10：上传编译日志（失败时）
      ###########################################################################
      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rt-kernel-logs-${{ env.BOARD }}-${{ github.run_number }}
          path: ${{ env.ARMBIAN_DIR }}/output/logs/
          retention-days: 7  # 日志保留7天