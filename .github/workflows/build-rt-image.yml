name: Build full offline bundle – OPi3B 6.1.115 + RT43

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

env:
  ARMBIAN_VER: v26.2.0-trunk.114
  BOARD:       orangepi3b
  BRANCH:      edge
  RELEASE:     trixie
  KERNEL_TAG:  v6.1.115
  PATCH_FILE:  patch-6.1.112-rt43.patch.xz

jobs:
  offline:
    runs-on: ubuntu-latest
    steps:
      # ---------- 1. 清理磁盘 ----------
      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      # ---------- 2. 检出 Armbian 构建框架 ----------
      - name: Checkout Armbian
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref:        ${{ env.ARMBIAN_VER }}
          path:       build

      # ---------- 3. 检出补丁仓库 ----------
      - name: Checkout patches repo
        uses: actions/checkout@v4
        with:
          path: patches

      # ---------- 4. 放置 RT 补丁 ----------
      - name: Install RT patch
        run: |
          mkdir -p build/userpatches
          xzcat patches/${{ env.PATCH_FILE }} > build/userpatches/kernel-rt.patch
          cat <<EOF > build/userpatches/lib.config
          LINUXFAMILY=rockchip64
          KERNELTAG='${{ env.KERNEL_TAG }}'
          KERNEL_PATCHES='userpatches/kernel-rt.patch'
          EOF

      # ---------- 5. 安装依赖 ----------
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu \
            libncurses-dev libssl-dev bc bison flex dwarves zstd \
            qemu-user-static

      # ---------- 6. 下载完整源码（容器内） ----------
      - name: Download sources
        working-directory: build
        run: |
          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=${{ env.BRANCH }} \
            RELEASE=${{ env.RELEASE }} \
            BUILD_ONLY=kernel \
            DOWNLOAD_ONLY=yes \
            KERNEL_CONFIGURE=no \
            BUILD_DESKTOP=no \
            BUILD_MINIMAL=yes

      # ---------- 7. 检查宿主机到底有啥 ----------
      - name: Check host dirs after download
        if: always()
        run: |
          echo "=== PWD ================================="
          pwd
          echo "=== GITHUB_WORKSPACE ===================="
          ls -la "$GITHUB_WORKSPACE"
          echo "=== build/ ==============================="
          ls -la build || true
          echo "=== cache/ ==============================="
          ls -la cache || true
          echo "=== output/ =============================="
          ls -la output || true

      # ---------- 8. 宿主机 tar（若目录存在） ----------
      - name: Pack on host (if dirs present)
        if: always()
        continue-on-error: true
        id:  host_tar
        run: |
          # 正常三目录全打
          tar --exclude='cache/aptcache/*/lock' \
              --exclude='cache/aptcache/*/partial' \
              -C "$GITHUB_WORKSPACE" \
              -cf - build cache output \
            | zstd -19 > full-offline-opi3b-6.1.115-rt43.tar.zst
          ls -lh full-offline-opi3b-6.1.115-rt43.tar.zst

      # ---------- 9. 容器内 tar + 拷出（宿主机失败时兜底） ----------
      - name: Pack inside Docker (fallback)
        if: always() && steps.host_tar.outcome == 'failure'
        working-directory: build
        run: |
          # 在容器里打包，然后 mv 到 /tmp 让宿主机拿到
          tar --exclude='cache/aptcache/*/lock' \
              --exclude='cache/aptcache/*/partial' \
              -C /armbian \
              -cf - build cache output \
            | zstd -19 > /tmp/offline.tar.zst
          sudo mv /tmp/offline.tar.zst "$GITHUB_WORKSPACE"/full-offline-opi3b-6.1.115-rt43.tar.zst
          ls -lh "$GITHUB_WORKSPACE"/full-offline-opi3b-6.1.115-rt43.tar.zst

      # ---------- 10. 上传 ----------
      - name: Upload bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-offline-opi3b-6.1.115-rt43
          path: full-offline-opi3b-6.1.115-rt43.tar.zst
          retention-days: 7
